<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CSV → JSON Stoplist</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
textarea { width: 100%; height: 300px; margin-top: 20px; }
button { margin-top: 10px; padding: 10px 20px; }
</style>
</head>
<body>

<h2>Парсер CSV → JSON Stoplist</h2>

<input type="file" id="csvFile" accept=".csv">
<button id="parseBtn">Парсить CSV</button>
<textarea id="jsonOutput" readonly placeholder="JSON объекты появятся здесь после парсинга..."></textarea>

<script>
document.getElementById('parseBtn').addEventListener('click', () => {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    if (!file) { alert('Выберите CSV файл!'); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        try {
            const objects = parseCSVtoStoplistObjects(text);
            const output = objects.map(o => JSON.stringify(o, null, 4)).join('\n\n');
            document.getElementById('jsonOutput').value = output;
            if (objects.length === 0) alert('Нет записей с unsub = 1');
        } catch (err) {
            alert(err.message);
        }
    };
    reader.readAsText(file);
});

function parseCSVtoStoplistObjects(csvText) {
    const lines = csvText.trim().split('\n');
    const delimiter = lines[0].includes(';') ? ';' : ',';
    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

    const emailIndex = headers.indexOf('email');
    const unsubIndex = headers.indexOf('unsub');
    if (emailIndex === -1 || unsubIndex === -1) {
        throw new Error('CSV должен содержать столбцы "email" и "unsub"');
    }

    const result = [];
    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const row = lines[i].split(delimiter).map(v => v.trim());
        if (row[unsubIndex] === '1') {
            result.push({ action: "stoplist.add", email: row[emailIndex] });
        }
    }
    return result;
}
</script>

</body>
</html>
