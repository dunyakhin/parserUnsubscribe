<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CSV → JSON (Sendsay subscriber/update)</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    button { padding: 8px 12px; }
    pre { background: #f5f5f5; padding: 10px; }
  </style>
</head>
<body>

<h2>CSV → JSON для Sendsay</h2>

<input type="file" id="file" accept=".csv">
<button onclick="convert()">Конвертировать</button>

<h3>JSON результат</h3>
<pre id="output"></pre>

<script>
function convert() {
  const fileInput = document.getElementById('file');
  const output = document.getElementById('output');

  if (!fileInput.files.length) {
    alert('Выбери CSV файл');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const text = e.target.result.trim();
      const lines = text.split(/\r?\n/);

      // автоопределение разделителя
      const delimiter = lines[0].includes(';') ? ';' : ',';

      const headers = lines[0].split(delimiter).map(h => h.trim().toUpperCase());
      const emailIndex = headers.indexOf('EMAIL');
      const unsubIndex = headers.indexOf('UNSUB');

      if (emailIndex === -1 || unsubIndex === -1) {
        throw new Error('В CSV должны быть столбцы EMAIL и unsub');
      }

      const list = [];

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(delimiter);
        if (!row[emailIndex]) continue;

        const email = row[emailIndex].trim().toLowerCase();
        if (!email.includes('@')) continue;

        list.push({
          email,
          unsub: row[unsubIndex].trim() === '1'
        });
      }

      const result = { list };
      output.textContent = JSON.stringify(result, null, 2);

    } catch (err) {
      output.textContent = 'Ошибка: ' + err.message;
    }
  };

  reader.readAsText(fileInput.files[0], 'windows-1251');
}
</script>

</body>
</html>

