<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CSV → JSON (Sendsay subscriber.update)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { padding: 8px 14px; margin-top: 10px; }
    pre { background: #f5f5f5; padding: 10px; margin-top: 15px; }
  </style>
</head>
<body>

<h2>CSV → JSON для обновления подписки (Sendsay)</h2>

<input type="file" id="csvFile" accept=".csv"><br>
<button onclick="convert()">Сформировать JSON</button>
<button onclick="download()" disabled id="downloadBtn">Скачать JSON</button>

<h3>Результат</h3>
<pre id="output"></pre>

<script>
let jsonResult = null;

function convert() {
  const fileInput = document.getElementById('csvFile');
  const output = document.getElementById('output');
  const downloadBtn = document.getElementById('downloadBtn');

  if (!fileInput.files.length) {
    alert('Выбери CSV файл');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const text = e.target.result.trim();
      const lines = text.split(/\r?\n/);

      const delimiter = lines[0].includes(';') ? ';' : ',';

      const headers = lines[0]
        .split(delimiter)
        .map(h => h.trim().toUpperCase());

      const emailIndex = headers.indexOf('EMAIL');
      const unsubIndex = headers.indexOf('UNSUB');

      if (emailIndex === -1 || unsubIndex === -1) {
        throw new Error('CSV должен содержать столбцы EMAIL и unsub');
      }

      const list = [];

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(delimiter);
        if (!row[emailIndex]) continue;

        const email = row[emailIndex].trim().toLowerCase();
        if (!email.includes('@')) continue;

        list.push({
          email,
          unsub: row[unsubIndex].trim() === '1'
        });
      }

      jsonResult = {
        action: "subscriber.update",
        list
      };

      output.textContent = JSON.stringify(jsonResult, null, 2);
      downloadBtn.disabled = false;

    } catch (err) {
      output.textContent = 'Ошибка: ' + err.message;
    }
  };

  reader.readAsText(fileInput.files[0], 'windows-1251');
}

function download() {
  if (!jsonResult) return;

  const blob = new Blob(
    [JSON.stringify(jsonResult, null, 2)],
    { type: 'application/json' }
  );

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'subscriber_update.json';
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
