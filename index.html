<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CSV → Sendsay subscriber.update</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { padding: 8px 14px; margin-top: 10px; }
    pre { background: #f5f5f5; padding: 10px; margin-top: 15px; }
    input { margin-top: 10px; }
  </style>
</head>
<body>

<h2>Обновление статуса подписки (Sendsay)</h2>

<label>
  Login:<br>
  <input type="text" id="login">
</label><br>

<label>
  API key:<br>
  <input type="password" id="apiKey">
</label><br>

<input type="file" id="csvFile" accept=".csv"><br>
<button onclick="sendToSendsay()">Загрузить и отправить</button>

<h3>Ответ API</h3>
<pre id="result"></pre>

<script>
function sendToSendsay() {
  const fileInput = document.getElementById('csvFile');
  const login = document.getElementById('login').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  const result = document.getElementById('result');

  if (!fileInput.files.length) {
    alert('Выбери CSV файл');
    return;
  }
  if (!login || !apiKey) {
    alert('Укажи login и api_key');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const text = e.target.result.trim();
      const lines = text.split(/\r?\n/);
      const delimiter = lines[0].includes(';') ? ';' : ',';

      const headers = lines[0]
        .split(delimiter)
        .map(h => h.trim().toUpperCase());

      const emailIndex = headers.indexOf('EMAIL');
      const unsubIndex = headers.indexOf('UNSUB');

      if (emailIndex === -1 || unsubIndex === -1) {
        throw new Error('CSV должен содержать столбцы EMAIL и unsub');
      }

      const list = [];

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(delimiter);
        if (!row[emailIndex]) continue;

        const email = row[emailIndex].trim().toLowerCase();
        if (!email.includes('@')) continue;

        list.push({
          email,
          unsub: row[unsubIndex].trim() === '1'
        });
      }

      const body = {
        action: "subscriber.update",
        login,
        api_key: apiKey,
        list
      };

      fetch('https://api.sendsay.ru/api/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(r => r.json())
      .then(data => {
        result.textContent = JSON.stringify(data, null, 2);
      })
      .catch(err => {
        result.textContent = 'Ошибка запроса: ' + err.message;
      });

    } catch (err) {
      result.textContent = 'Ошибка: ' + err.message;
    }
  };

  reader.readAsText(fileInput.files[0], 'windows-1251');
}
</script>

</body>
</html>

